<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for L2/RandomPack.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">L2/</a> RandomPack.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/59</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.25;
&nbsp;
import { ReentrancyGuard } from "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import { SafeERC20 } from "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
import { IERC20 } from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import { IGemFactory } from "../interfaces/IGemFactory.sol";
import { GemFactoryStorage } from "./GemFactoryStorage.sol";  
import {AuthControl} from "../common/AuthControl.sol";
import { IERC721Receiver } from "@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol";
import { RandomPackStorage } from "./RandomPackStorage.sol";
import "../proxy/ProxyStorage.sol";
&nbsp;
import {DRBConsumerBase} from "./Randomness/DRBConsumerBase.sol";
import {IDRBCoordinator} from "../interfaces/IDRBCoordinator.sol";
&nbsp;
interface ITreasury {
    function transferWSTON(address _to, uint256 _amount) external returns(bool);
    function transferTreasuryGEMto(address _to, uint256 _tokenId) external returns(bool);
    function getWSTONBalance() external view returns (uint256);
    function createPreminedGEM( 
        GemFactoryStorage.Rarity _rarity,
        uint8[2] memory _color, 
        uint8[4] memory _quadrants,  
        string memory _tokenURI
    ) external returns (uint256);
}
&nbsp;
/**
 * @title RandomPack Contract for GEM Distribution
 * @author TOKAMAK OPAL TEAM
 * @notice This contract facilitates the creation and distribution of random GEM tokens.
 * @dev The contract integrates with external systems (Gem Factory, Treasury, and a Randomness Coordinator).
 * It allows users to request random GEMs by paying a fee and handles the minting and transfer of GEMs.
 * The contract includes mechanisms for pausing operations and managing fees.
 */
contract RandomPack is ProxyStorage, ReentrancyGuard, IERC721Receiver, AuthControl, DRBConsumerBase, RandomPackStorage {
    using SafeERC20 for IERC20;
&nbsp;
    /**
     * @notice Modifier to ensure the contract is not paused.
     */
<span class="fstat-no" title="function not covered" >    modifier whenNotPaused() {</span>
<span class="cstat-no" title="statement not covered" >      require(!paused, "Pausable: paused")</span>;
      _;
    }
&nbsp;
    /**
     * @notice Modifier to ensure the contract is paused.
     */
<span class="fstat-no" title="function not covered" >    modifier whenPaused() {</span>
<span class="cstat-no" title="statement not covered" >        require(paused, "Pausable: not paused")</span>;
        _;
    }
&nbsp;
    /**
     * @notice Pauses the contract, preventing certain actions.
     * @dev Only callable by the owner when the contract is not paused.
     */
<span class="fstat-no" title="function not covered" >    function pause() public onlyOwner whenNotPaused {</span>
        paused = true;
    }
&nbsp;
    /**
     * @notice Unpauses the contract, allowing actions to be performed.
     * @dev Only callable by the owner when the contract is paused.
     */
<span class="fstat-no" title="function not covered" >    function unpause() public onlyOwner whenNotPaused {</span>
        paused = false;
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //--------------------------------INITIALIZE FUNCTIONS-----------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
    /**
     * @notice Initializes the RandomPack contract with the given parameters.
     * @param _coordinator Address of the  DRBCoordinator contract.
     * @param _ton Address of the TON token.
     * @param _gemFactory Address of the gem factory contract.
     * @param _treasury Address of the treasury contract.
     * @param _randomPackFees Fees for requesting a random pack.
     */
<span class="fstat-no" title="function not covered" >    function initialize(</span>
        address _coordinator,  
        address _ton, 
        address _gemFactory, 
        address _treasury, 
        uint256 _randomPackFees
    ) external {
<span class="cstat-no" title="statement not covered" >        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender)</span>;
<span class="cstat-no" title="statement not covered" >        __DRBConsumerBase_init(_coordinator)</span>;
        gemFactory = _gemFactory;
        treasury = _treasury;
        ton = _ton;
        randomPackFees = _randomPackFees;
        callbackGasLimit = 600000;
        perfectCommonGemURI = "";
    }
&nbsp;
    /** 
     * @notice Sets the address of the gem factory.
     * @param _gemFactory New address of the gem factory contract.
     */
<span class="fstat-no" title="function not covered" >    function setGemFactory(address _gemFactory) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if(gemFactory == address(0)) {</span>
            revert InvalidAddress();
        }
        gemFactory = _gemFactory;
<span class="cstat-no" title="statement not covered" >        emit GemFactoryAddressUpdated(_gemFactory);</span>
    }
&nbsp;
    /**
     * @notice Sets the fees for requesting a random pack.
     * @param _randomPackFees New fees for random pack requests.
     */
<span class="fstat-no" title="function not covered" >    function setRandomPackFees(uint256 _randomPackFees) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if(randomPackFees == 0) {</span>
            revert RandomPackFeesEqualToZero();
        }
        randomPackFees = _randomPackFees;
<span class="cstat-no" title="statement not covered" >        emit RandomPackFeesUpdated(_randomPackFees);</span>
    }
&nbsp;
    /**
     * @notice Sets the address of the treasury.
     * @param _treasury New address of the treasury contract.
     */
<span class="fstat-no" title="function not covered" >    function setTreasury(address _treasury) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if(_treasury == address(0)) {</span>
            revert InvalidAddress();
        }
        treasury = _treasury;
<span class="cstat-no" title="statement not covered" >        emit TreasuryAddressUpdated(_treasury);</span>
    }
&nbsp;
    /**
     * @notice Sets the URI for the perfect common GEM.
     * @param _tokenURI New URI for the perfect common GEM.
     */
<span class="fstat-no" title="function not covered" >    function setPerfectCommonGemURI(string memory _tokenURI) external onlyOwner {</span>
        perfectCommonGemURI = _tokenURI;
<span class="cstat-no" title="statement not covered" >        emit PerfectCommonGemURIUpdated(_tokenURI);</span>
    }
&nbsp;
    /**
     * @notice Sets the gas limit for the callback function.
     * @param _callbackGasLimit New gas limit for the callback function.
     */
<span class="fstat-no" title="function not covered" >    function setCallbackGasLimit(uint32 _callbackGasLimit) external onlyOwner {</span>
        callbackGasLimit = _callbackGasLimit;
<span class="cstat-no" title="statement not covered" >        emit CallBackGasLimitUpdated(_callbackGasLimit);</span>
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //--------------------------------EXTERNAL FUNCTIONS-------------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
    /**
     * @notice Requests a random GEM and pays the required fees.
     * @return uint256 Returns the request ID for the randomness request.
     * @dev function has nonReentrant modifier and follows CEI
     */
<span class="fstat-no" title="function not covered" >    function requestRandomGem() external payable whenNotPaused nonReentrant returns(uint256) {</span>
<span class="cstat-no" title="statement not covered" >        if(msg.sender == address(0)) {</span>
            revert InvalidAddress();
        }
        //users pays upfront fees
        //user must approve the contract for the fees amount before calling the function
<span class="cstat-no" title="statement not covered" >        IERC20(ton).safeTransferFrom(msg.sender, address(this), randomPackFees)</span>;
        
        // Request randomness from the consumer with default parameters
<span class="cstat-no" title="statement not covered" >        (uint256 directFundingCost, uint256 requestId) = requestRandomness(0,0,callbackGasLimit);        </span>
&nbsp;
        // Update the request mapping with details of the request
        s_requests[requestId].requested = true;
        s_requests[requestId].requester = msg.sender;
        unchecked {
            // Increment the request count
            requestCount++;
        }
&nbsp;
        // Refund excess ETH to the user if they overpaid
<span class="cstat-no" title="statement not covered" >        if(msg.value &gt; directFundingCost) { // if there is ETH to refund</span>
<span class="cstat-no" title="statement not covered" >            (bool success, ) = msg.sender.call{value:  msg.value - directFundingCost}("");</span>
<span class="cstat-no" title="statement not covered" >            if(!success) {</span>
                revert FailedToSendEthBack();
            }
            // Emit an event for the ETH refund
<span class="cstat-no" title="statement not covered" >            emit EthSentBack(msg.value - directFundingCost);</span>
        }
&nbsp;
        // Emit an event for the random GEM request
<span class="cstat-no" title="statement not covered" >        emit RandomGemRequested(msg.sender);</span>
<span class="cstat-no" title="statement not covered" >        return requestId;</span>
    }
&nbsp;
    /**
     * @notice Handles the receipt of an ERC721 token.
     * @return bytes4 Returns the selector of the onERC721Received function.
     */
<span class="fstat-no" title="function not covered" >    function onERC721Received(</span>
        address /*operator*/,
        address /*from*/,
        uint256 /*tokenId*/,
        bytes calldata /*data*/
    ) external pure override returns (bytes4) {
<span class="cstat-no" title="statement not covered" >        return this.onERC721Received.selector;</span>
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //--------------------------------INTERNAL FUNCTIONS-------------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
    /**
     * @notice Fulfills the randomness request with the given random number and transfers a random GEM to the appropriate user
     * @dev the function lists down the Gems available in the treasury (not locked) through the getGemListAvailableForRandomPack function 
     * @dev if there is no gem available, the function creates a new common gem with specific attributes
     * @param requestId The ID of the randomness request.
     * @param randomNumber The random number generated.
     */
<span class="fstat-no" title="function not covered" >    function fulfillRandomWords(uint256 requestId, uint256 randomNumber) internal override {</span>
<span class="cstat-no" title="statement not covered" >        if(!s_requests[requestId].requested) {</span>
            revert RequestNotMade();
        }
        s_requests[requestId].fulfilled = true;
        s_requests[requestId].randomWord = randomNumber;
&nbsp;
<span class="cstat-no" title="statement not covered" >        (uint256 gemCount, uint256[] memory tokenIds) = IGemFactory(gemFactory).getGemListAvailableForRandomPack();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if(gemCount &gt; 0) {</span>
            // same calculation as for the mining process
<span class="cstat-no" title="statement not covered" >            uint256 modNbGemsAvailable = (randomNumber % gemCount);</span>
            s_requests[requestId].chosenTokenId = tokenIds[modNbGemsAvailable];
            // transfer the gem from the treasury to the user.
<span class="cstat-no" title="statement not covered" >            ITreasury(treasury).transferTreasuryGEMto(s_requests[requestId].requester, s_requests[requestId].chosenTokenId)</span>;
<span class="cstat-no" title="statement not covered" >            emit RandomGemTransferred(s_requests[requestId].chosenTokenId, s_requests[requestId].requester);</span>
        } else {
            // if there is no gem available in the pool, we mint a new perfect common gem. note that it reverts if the treasury does not have enough WSTON.
            s_requests[requestId].chosenTokenId = ITreasury(treasury).createPreminedGEM(GemFactoryStorage.Rarity.COMMON, [0,0], [1,1,1,1], "");
<span class="cstat-no" title="statement not covered" >            ITreasury(treasury).transferTreasuryGEMto(msg.sender, s_requests[requestId].chosenTokenId)</span>;
<span class="cstat-no" title="statement not covered" >            emit CommonGemMinted();</span>
        }
    }
&nbsp;
&nbsp;
    //---------------------------------------------------------------------------------------
    //-------------------------------STORAGE GETTERS-----------------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
<span class="fstat-no" title="function not covered" >    function getTreasuryAddress() external view returns(address) {<span class="cstat-no" title="statement not covered" >return treasury;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getGemFactoryAddress() external view returns(address) {<span class="cstat-no" title="statement not covered" >return gemFactory;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getTonAddress() external view returns(address) {<span class="cstat-no" title="statement not covered" >return ton;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getCallbackGasLimit() external view returns(uint32) {<span class="cstat-no" title="statement not covered" >return callbackGasLimit;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getRequestCount() external view returns(uint256) {<span class="cstat-no" title="statement not covered" >return requestCount;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getRandomPackFees() external view returns(uint256) {<span class="cstat-no" title="statement not covered" >return randomPackFees;</span>}</span>
<span class="fstat-no" title="function not covered" >    function getPerfectCommonGemURI() external view returns(string memory) {<span class="cstat-no" title="statement not covered" >return perfectCommonGemURI;</span>}</span>
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 11 2024 15:51:23 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
