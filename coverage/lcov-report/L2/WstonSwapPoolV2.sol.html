<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for L2/WstonSwapPoolV2.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">L2/</a> WstonSwapPoolV2.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/33</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity 0.8.25;
&nbsp;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {AuthControl} from "../common/AuthControl.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "../proxy/ProxyStorage.sol";
&nbsp;
import { WstonSwapPoolStorageV2 } from "./WstonSwapPoolStorageV2.sol";
&nbsp;
interface ITreasury {
    function tonApproveWstonSwapPool(uint256 _amount) external returns(bool);
}
&nbsp;
/**
 * @title WstonSwapPoolV2 Contract for Token Swapping
 * @author TOKAMAK OPAL TEAM
 * @notice This contract facilitates the swapping of WSTON tokens for TON tokens directly from users to the treasury
 * It manages the exchange rate through a staking index.
 * The contract includes mechanisms for pausing operations and ensuring secure token transfers.
 * @dev The contract uses OpenZeppelin's ReentrancyGuard for security and AuthControl for access management.
 */
contract WstonSwapPoolV2 is ProxyStorage, AuthControl, ReentrancyGuard, WstonSwapPoolStorageV2 {
&nbsp;
    /**
     * @notice Modifier to ensure the contract is not paused.
     */
<span class="fstat-no" title="function not covered" >    modifier whenNotPaused() {</span>
<span class="cstat-no" title="statement not covered" >      require(!paused, "Pausable: paused")</span>;
      _;
    }
&nbsp;
    /**
     * @notice Modifier to ensure the contract is paused.
     */
<span class="fstat-no" title="function not covered" >    modifier whenPaused() {</span>
<span class="cstat-no" title="statement not covered" >        require(paused, "Pausable: not paused")</span>;
        _;
    }
    
    /**
     * @notice Modifier to ensure the caller is the treasury contract
     */
<span class="fstat-no" title="function not covered" >    modifier onlyTreasury() {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            msg.sender == treasury, 
            "function callable from treasury contract only"
        );
        _;
    }
&nbsp;
    /**
     * @notice Pauses the contract, preventing certain actions.
     * @dev Only callable by the owner when the contract is not paused.
     */
<span class="fstat-no" title="function not covered" >    function pause() public onlyOwner whenNotPaused {</span>
        paused = true;
    }
&nbsp;
    /**
     * @notice Unpauses the contract, allowing actions to be performed.
     * @dev Only callable by the owner when the contract is paused.
     */
<span class="fstat-no" title="function not covered" >    function unpause() public onlyOwner whenNotPaused {</span>
        paused = false;
    }
&nbsp;
    /**
     * @notice Initializes the WstonSwapPool contract with the given parameters.
     * @param _ton The address of the TON token contract.
     * @param _wston The address of the WSTON token contract.
     * @param _initialStakingIndex The initial staking index value.
     * @param _treasury The address of the treasury contract.
     * @dev Can only be called once. Grants the caller the default admin role.
     */
<span class="fstat-no" title="function not covered" >    function initialize(</span>
        address _ton, 
        address _wston,
        uint256 _initialStakingIndex, 
        address _treasury
    ) external {
<span class="cstat-no" title="statement not covered" >        require(!initialized, "already initialized")</span>;   
<span class="cstat-no" title="statement not covered" >        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender)</span>;
        ton = _ton;
        wston = _wston;
        treasury = _treasury;
        stakingIndex = _initialStakingIndex;
        initialized = true;
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //--------------------------------EXTERNAL FUNCTIONS-------------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
    /**
     * @notice Swaps a specified amount of WSTON for TON tokens.
     * @dev The function checks allowances and balances before performing the swap.
     * Emits a `SwappedWstonForTon` event upon successful swap.
     * @dev Before using this funciton, treasury must approve this contract for TON =&gt; type(uint256).max 
     * @param wstonAmount The amount of WSTON tokens to swap.
     */
<span class="fstat-no" title="function not covered" >    function swap(uint256 wstonAmount) external nonReentrant {</span>
        // Checks if the caller approved the Swapper to spend WSTON
<span class="cstat-no" title="statement not covered" >        if(IERC20(wston).allowance(msg.sender, address(this)) &lt; wstonAmount) {</span>
            revert WstonAllowanceTooLow();
        }
&nbsp;
        // Checks if the caller has enough WSTON
<span class="cstat-no" title="statement not covered" >        if(IERC20(wston).balanceOf(msg.sender) &lt; wstonAmount) {</span>
            revert WstonBalanceTooLow();
        }
        
        // calculate the ton Amount based on the staking index
<span class="cstat-no" title="statement not covered" >        uint256 tonAmount = ((wstonAmount * stakingIndex) / DECIMALS) / (10**9);</span>
&nbsp;
        // make the treasury approve the swapper to spend TON
<span class="cstat-no" title="statement not covered" >        if(!ITreasury(treasury).tonApproveWstonSwapPool(tonAmount)) {</span>
            revert FailedToApproveTon(tonAmount);
        }
&nbsp;
        // Checks if treasury holds enough TON
<span class="cstat-no" title="statement not covered" >        if(IERC20(ton).balanceOf(treasury) &lt; tonAmount) {</span>
            revert ContractTonBalanceOrAllowanceTooLow();
        }
&nbsp;
        // transfers WSTON from the caller to the treasury
<span class="cstat-no" title="statement not covered" >        _safeTransferFrom(IERC20(wston), msg.sender, treasury, wstonAmount)</span>;
        // Transfers TON from the treasury to the user
<span class="cstat-no" title="statement not covered" >        _safeTransferFrom(IERC20(ton), treasury, msg.sender, tonAmount)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit SwappedWstonForTon(msg.sender, tonAmount, wstonAmount);</span>
    }
&nbsp;
    /**
     * @notice Updates the staking index used for calculating swap rates.
     * @dev The new index must be greater than or equal to 10^27.
     * Emits a `StakingIndexUpdated` event upon successful update.
     * @param newIndex The new staking index value.
     */
<span class="fstat-no" title="function not covered" >    function updateStakingIndex(uint256 newIndex) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if(newIndex &lt; 10**27) {</span>
            revert WrongStakingIndex();
        }
        stakingIndex = newIndex;
<span class="cstat-no" title="statement not covered" >        emit StakingIndexUpdated(newIndex);</span>
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //-----------------------------INTERNAL/PRIVATE FUNCTIONS--------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
<span class="fstat-no" title="function not covered" >    function _safeTransferFrom(IERC20 token, address sender, address recipient, uint256 amount) private {</span>
<span class="cstat-no" title="statement not covered" >        bool sent = token.transferFrom(sender, recipient, amount);</span>
<span class="cstat-no" title="statement not covered" >        require(sent, "Token transfer failed")</span>;
    }
&nbsp;
    //---------------------------------------------------------------------------------------
    //------------------------STORAGE GETTER / VIEW FUNCTIONS--------------------------------
    //---------------------------------------------------------------------------------------
&nbsp;
<span class="fstat-no" title="function not covered" >    function getStakingIndex() external view returns(uint256) {<span class="cstat-no" title="statement not covered" >return stakingIndex;</span>}</span>
&nbsp;
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 11 2024 15:51:23 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
